<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de XML/TXT para ABRASF 2.01</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca JSZip para criar arquivos .ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Bibliotecas jsPDF e jsPDF-AutoTable para gerar relatórios em PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Biblioteca PDF.js para ler arquivos PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Configura o caminho para o worker do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    <style>
        /* Estilos adicionais para feedback visual */
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active, #modoGeracao button.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #f3f4f6;
        }
        .file-item-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 1rem;
        }
        .drag-drop-area {
            border: 2px dashed #d1d5db;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .drag-drop-area.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <div class="bg-white p-8 rounded-2xl shadow-lg">

            <!-- Cabeçalho -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Conversor para ABRASF</h1>
                <p class="text-gray-500 mt-2">Converta seus arquivos XML, TXT ou PDF de NFS-e para o padrão ABRASF 2.01.</p>
            </div>

            <!-- Passo 1: Configuração -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Passo 1: Configuração do Prestador</h2>
                <div class="grid grid-cols-1 gap-y-4">
                     <div>
                        <label for="cnpjCliente" class="block text-sm font-medium text-gray-600 mb-1">CNPJ da sua empresa</label>
                        <input type="text" id="cnpjCliente" placeholder="Digite os 14 dígitos do CNPJ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="razaoSocialEmpresa" class="block text-sm font-medium text-gray-600 mb-1">Razão Social da sua empresa</label>
                            <input type="text" id="razaoSocialEmpresa" placeholder="Preenchido automaticamente" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                        </div>
                        <div>
                            <label for="imEmpresa" class="block text-sm font-medium text-gray-600 mb-1">Inscrição Municipal <span class="text-xs text-gray-400 font-normal">(Opcional se constar no arquivo)</span></label>
                            <input type="text" id="imEmpresa" placeholder="Digite a Inscrição Municipal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="ufEmpresa" class="block text-sm font-medium text-gray-600 mb-1">UF da Empresa</label>
                            <select id="ufEmpresa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white">
                                <option value="">Selecione a UF</option>
                            </select>
                        </div>
                        <div>
                            <label for="municipioEmpresa" class="block text-sm font-medium text-gray-600 mb-1">Município da Empresa</label>
                            <input type="text" id="municipioEmpresa" list="municipiosList" placeholder="Selecione ou digite" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" disabled>
                            <datalist id="municipiosList"></datalist>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Modo de Geração</label>
                        <div id="modoGeracao" class="flex space-x-2">
                            <button data-mode="LOTE" class="flex-1 py-2 px-4 rounded-lg border transition active text-gray-600 hover:bg-blue-500 hover:text-white active">Em Lote</button>
                            <button data-mode="INDIVIDUAL" class="flex-1 py-2 px-4 rounded-lg border transition text-gray-600 hover:bg-blue-500 hover:text-white">Individual</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passo 2: Seleção de Arquivos (com Abas) -->
            <div class="mb-6">
                 <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Passo 2: Seleção de Arquivos</h2>
                <!-- Abas -->
                <div class="mb-4 flex border-b">
                    <button id="tab-xml" class="tab-button active py-2 px-4 border-b-2" data-tab="xml">XML</button>
                    <button id="tab-txt" class="tab-button py-2 px-4 border-b-2" data-tab="txt">TXT (Nota Paulistana)</button>
                    <button id="tab-pdf" class="tab-button py-2 px-4 border-b-2" data-tab="pdf">PDF (Fatura Locação)</button>
                </div>

                <!-- Área de Upload XML -->
                <div id="upload-xml-area">
                    <div id="drag-drop-area-xml" class="drag-drop-area relative p-6 text-center rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="file" id="xmlFilesInput" multiple accept=".xml" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="flex flex-col items-center justify-center pointer-events-none">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-blue-600">Clique para selecionar</span> ou arraste os arquivos aqui.</p>
                            <p class="text-xs text-gray-500">Apenas arquivos .XML são permitidos</p>
                        </div>
                    </div>
                </div>

                <!-- Área de Upload TXT -->
                <div id="upload-txt-area" class="hidden">
                     <div id="drag-drop-area-txt" class="drag-drop-area relative p-6 text-center rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="file" id="txtFilesInput" multiple accept=".txt,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                         <div class="flex flex-col items-center justify-center pointer-events-none">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-blue-600">Clique para selecionar</span> ou arraste o arquivo aqui.</p>
                            <p class="text-xs text-gray-500">Apenas arquivos .TXT (formato Nota Fiscal Paulistana) são permitidos</p>
                        </div>
                    </div>
                </div>

                <!-- Área de Upload PDF -->
                <div id="upload-pdf-area" class="hidden">
                     <div id="drag-drop-area-pdf" class="drag-drop-area relative p-6 text-center rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="file" id="pdfFilesInput" multiple accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                         <div class="flex flex-col items-center justify-center pointer-events-none">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-blue-600">Clique para selecionar</span> ou arraste o arquivo aqui.</p>
                            <p class="text-xs text-gray-500">Apenas arquivos .PDF (Fatura de Locação) são permitidos</p>
                        </div>
                    </div>
                    <div id="competencia-pdf-section" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="competenciaMes" class="block text-sm font-medium text-gray-600 mb-1">Mês de Competência</label>
                            <select id="competenciaMes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white">
                                <option value="">Selecione o Mês</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div>
                            <label for="competenciaAno" class="block text-sm font-medium text-gray-600 mb-1">Ano de Competência</label>
                            <input type="number" id="competenciaAno" placeholder="AAAA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>
                </div>

                <div id="fileList" class="mt-4 space-y-2"></div>
            </div>

            <!-- Passo 3: Processar -->
            <div class="text-center">
                <button id="processarBtn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Processar Arquivos
                </button>
            </div>

            <!-- Passo 4: Resultados -->
            <div id="resultados" class="mt-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Passo 4: Resultados</h2>
                <div id="logMessages" class="bg-gray-50 p-4 rounded-lg max-h-40 overflow-y-auto mb-4 text-sm font-mono"></div>
                <div id="downloadLinks" class="space-y-3"></div>
            </div>

        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>&copy; 2024 Conversor ABRASF. Seus arquivos são processados localmente no seu navegador.</p>
        </footer>
    </div>

    <script type="module">
        // Módulo principal da aplicação
        window.addEventListener('DOMContentLoaded', async (event) => {
		const { jsPDF } = window.jspdf;

        // --- Variáveis Globais e Estado da Aplicação ---
        let modoGeracaoEscolhido = 'LOTE'; 
        let arquivosSelecionados = [];
        let activeTab = 'xml';
        let codigosIBGE = {};
        let normalizedCodigosIBGE = {};
        let codigosPorUF = {};
        let reverseCodigosIBGE = {};
        let dadosEmpresaPrestadora = null;

        // --- Referências aos Elementos do DOM ---
        const cnpjInput = document.getElementById('cnpjCliente');
        const razaoSocialEmpresaInput = document.getElementById('razaoSocialEmpresa');
        const imEmpresaInput = document.getElementById('imEmpresa');
        const ufEmpresaSelect = document.getElementById('ufEmpresa');
        const municipioEmpresaInput = document.getElementById('municipioEmpresa');
        const municipiosList = document.getElementById('municipiosList');
        const modoGeracaoButtons = document.querySelectorAll('#modoGeracao button');
        const processarBtn = document.getElementById('processarBtn');
        const tabXmlBtn = document.getElementById('tab-xml');
        const tabTxtBtn = document.getElementById('tab-txt');
        const tabPdfBtn = document.getElementById('tab-pdf');
        const uploadXmlArea = document.getElementById('upload-xml-area');
        const uploadTxtArea = document.getElementById('upload-txt-area');
        const uploadPdfArea = document.getElementById('upload-pdf-area');
        const xmlFilesInput = document.getElementById('xmlFilesInput');
        const txtFilesInput = document.getElementById('txtFilesInput');
        const pdfFilesInput = document.getElementById('pdfFilesInput');
        const dragDropAreaXml = document.getElementById('drag-drop-area-xml');
        const dragDropAreaTxt = document.getElementById('drag-drop-area-txt');
        const dragDropAreaPdf = document.getElementById('drag-drop-area-pdf');
        const competenciaPdfSection = document.getElementById('competencia-pdf-section');
        const competenciaMesSelect = document.getElementById('competenciaMes');
        const competenciaAnoInput = document.getElementById('competenciaAno');
        const fileListDiv = document.getElementById('fileList');
        const resultadosDiv = document.getElementById('resultados');
        const logMessagesDiv = document.getElementById('logMessages');
        const downloadLinksDiv = document.getElementById('downloadLinks');

        // --- Dicionários de Mapeamento ---
        const mapaServicos = {
            "01015": "7.02", "01023": "7.02", "01024": "7.02", "01031": "7.04", "01032": "7.04", "01058": "7.05", "01059": "7.05",
            "01090": "7.15", "01104": "14.13", "01105": "14.13", "01112": "7.02", "01113": "7.02", "01114": "7.02", "01115": "7.04",
            "01116": "7.05", "01117": "7.15", "01118": "14.13", "01119": "7.17", "01121": "7.18", "01139": "7.11", "01210": "7.01",
            "01228": "7.06", "01236": "7.07", "01244": "7.08", "01325": "7.09", "01384": "7.10", "01406": "7.10", "01422": "7.10",
            "01430": "7.11", "01449": "7.11", "01465": "7.13", "01473": "7.16", "01481": "22.01", "01503": "7.01", "01504": "7.01",
            "01520": "7.01", "01538": "7.01", "01546": "7.01", "01589": "7.01", "01600": "7.01", "01627": "7.01", "01694": "7.03",
            "01724": "7.12", "01740": "7.14", "01741": "7.14", "01805": "7.17", "01821": "7.18", "01848": "7.18", "01856": "7.18",
            "01864": "7.19", "01872": "7.20", "01880": "14.02", "01899": "17.03", "01902": "17.08", "01903": "17.08", "02020": "17.08",
            "02038": "17.16", "02054": "23.01", "02062": "23.01", "02097": "27.01", "02100": "27.01", "02119": "28.01", "02135": "28.01",
            "02143": "30.01", "02151": "31.01", "02186": "32.01", "02194": "32.01", "02216": "36.01", "02224": "38.01", "02232": "7.03",
            "02233": "31.01", "02321": "16.01", "02330": "16.01", "02340": "16.01", "02348": "16.01", "02364": "16.01", "02350": "16.02",
            "02366": "16.02", "02402": "16.01", "02410": "16.01", "02429": "16.01", "02445": "16.01", "02404": "16.02", "02412": "16.02",
            "02431": "16.02", "02447": "16.02", "02453": "26.01", "02461": "26.01", "02488": "16.01", "02489": "16.02", "02496": "17.06",
            "02498": "17.24", "02499": "17.24", "02500": "23.01", "02501": "23.01", "02502": "23.01", "02526": "35.01", "02534": "35.01",
            "02542": "17.06", "02658": "1.01", "02666": "1.02", "02682": "1.03", "02683": "1.01", "02690": "1.04", "02691": "1.04",
            "02798": "1.05", "02660": "1.01", "02668": "1.02", "02684": "1.03", "02692": "1.04", "02685": "1.01", "02693": "1.04",
            "02800": "1.05", "02836": "2.01", "02879": "1.06", "02917": "1.07", "02918": "1.07", "02933": "1.08", "02881": "1.06",
            "02919": "1.07", "02920": "1.07", "02935": "1.08", "02961": "1.09", "02962": "1.09", "02963": "1.09", "02964": "1.09",
            "02965": "1.09", "02966": "1.09", "03085": "2.01", "03093": "17.01", "03115": "17.01", "03123": "17.02", "03131": "17.02",
            "03158": "17.02", "03159": "17.02", "03166": "17.02", "02686": "1.09", "03167": "17.02", "03174": "17.02", "03204": "17.11",
            "03205": "17.11", "03206": "17.11", "03207": "17.11", "03208": "17.11", "03210": "17.11", "03212": "17.11", "03213": "17.11",
            "03214": "17.11", "03220": "17.13", "03239": "17.13", "03379": "17.13", "03387": "17.14", "03395": "17.15", "03425": "17.15",
            "03433": "17.15", "03450": "17.17", "03468": "17.17", "03476": "17.18", "03611": "17.18", "03620": "17.18", "03638": "17.18",
            "03654": "17.19", "03670": "17.19", "03700": "17.19", "03719": "17.20", "03743": "17.22", "03751": "17.23", "03877": "21.01",
            "03878": "21.01", "03956": "29.01", "03980": "17.01", "03981": "17.11", "04030": "4.01", "04073": "4.01", "04111": "4.01",
            "04139": "4.02", "04140": "4.02", "04146": "4.02", "04154": "4.02", "04170": "4.02", "4170": "4.02", "04189": "4.03", "04197": "4.03",
            "04219": "4.03", "04235": "4.03", "04251": "4.04", "04260": "4.05", "04278": "4.05", "04316": "4.06", "04340": "4.06",
            "04359": "4.06", "04375": "4.06", "04383": "4.07", "04391": "4.08", "04421": "4.08", "04430": "4.08", "04472": "4.08",
            "04499": "4.08", "04502": "4.08", "04510": "4.08", "04545": "4.08", "04553": "4.08", "04588": "4.09", "04596": "4.09",
            "04626": "4.10", "04634": "4.11", "04650": "4.11", "04677": "4.11", "04693": "4.12", "04723": "4.12", "04731": "4.12",
            "04774": "4.13", "04871": "4.13", "04901": "4.13", "05037": "4.14", "05053": "4.14", "05096": "4.14", "05100": "4.15",
            "05118": "4.16", "05134": "4.16", "05142": "4.16", "05150": "4.17", "05177": "4.17", "05185": "4.17", "05193": "4.18",
            "05223": "4.19", "05231": "4.20", "05266": "4.21", "05274": "4.22", "05312": "4.23", "05380": "5.01", "05398": "5.01",
            "05410": "5.01", "05428": "5.02", "05436": "5.03", "05460": "5.04", "05479": "5.05", "05495": "5.06", "05517": "5.07",
            "05533": "5.09", "05539": "4.07", "05540": "4.10", "05542": "4.03", "05543": "4.22", "05576": "4.02", "05584": "4.17",
            "05657": "6.04", "05665": "6.04", "05673": "8.01", "05681": "8.01", "05690": "8.01", "05711": "8.01", "05720": "8.01",
            "05738": "8.02", "05754": "8.02", "05762": "8.02", "05771": "15.01", "05800": "15.01", "05820": "15.01", "05836": "15.01",
            "05837": "15.01", "05851": "15.09", "05878": "15.02", "05870": "15.03", "05871": "15.04", "05872": "15.05", "05873": "15.06",
            "05874": "15.07", "05875": "15.08", "05876": "15.10", "05877": "15.10", "05879": "15.11", "05881": "15.13", "05885": "15.17",
            "05886": "15.18", "05887": "15.14", "05888": "15.12", "05889": "15.12", "05890": "15.15", "05891": "15.15", "05892": "15.16",
            "05893": "15.16", "05894": "17.11", "05895": "15.10", "05896": "17.11", "05916": "18.01", "05991": "10.09", "06009": "10.09",
            "06017": "10.10", "06041": "10.10", "06050": "10.01", "06076": "10.01", "06084": "10.01", "06092": "10.01", "06114": "10.01",
            "06122": "10.01", "06130": "10.01", "06149": "10.01", "06157": "10.02", "06165": "10.02", "06173": "10.03", "06181": "10.03",
            "06190": "10.04", "06220": "10.04", "06221": "10.04", "06238": "10.04", "06262": "10.04", "06263": "10.04", "06270": "10.05",
            "06297": "10.05", "06298": "10.05", "06299": "10.05", "06301": "10.05", "06302": "10.05", "06303": "10.05", "06319": "10.05",
            "06320": "10.05", "06321": "10.05", "06322": "10.05", "06323": "10.05", "06324": "10.05", "06335": "10.06", "06343": "10.06",
            "06351": "10.07", "06386": "10.07", "06394": "10.08", "06432": "10.08", "06475": "17.04", "06491": "17.05", "06513": "17.05",
            "06521": "17.07", "06522": "17.07", "06530": "17.12", "06556": "17.12", "06557": "17.12", "06564": "17.21", "06572": "25.01",
            "06581": "25.02", "06599": "25.02", "06602": "25.03", "06610": "25.04", "06613": "25.05", "06637": "33.01", "06645": "33.01",
            "06653": "17.04", "06654": "17.07", "06655": "17.04", "06777": "12.13", "06793": "13.01", "06794": "13.01", "06807": "13.02",
            "06808": "13.02", "06815": "13.03", "06816": "13.03", "06817": "13.03", "06831": "14.07", "06840": "14.07", "06858": "14.08",
            "06890": "14.08", "06912": "13.04", "06920": "13.04", "06939": "13.04", "06955": "13.04", "06940": "13.04", "06956": "13.04",
            "06963": "24.01", "06971": "12.13", "06972": "13.01", "06973": "13.02", "06974": "13.03", "07005": "9.01", "07013": "9.01",
            "07056": "9.01", "07099": "9.01", "07100": "9.01", "07110": "9.02", "07129": "9.02", "07109": "9.02", "07111": "9.02",
            "07123": "9.02", "07124": "9.02", "07137": "9.03", "07153": "9.03", "07161": "17.09", "07170": "17.09", "07196": "17.10",
            "07218": "12.17", "07234": "12.17", "07235": "17.10", "07285": "14.06", "07315": "14.06", "07324": "14.14", "07323": "14.06",
            "07331": "14.01", "07366": "14.01", "07390": "14.01", "07412": "14.01", "07439": "14.01", "07447": "14.01", "07455": "14.01",
            "07471": "14.01", "07498": "14.01", "07510": "14.01", "07528": "14.01", "07536": "14.01", "07552": "14.03", "07560": "14.04",
            "07579": "14.05", "07595": "14.09", "07609": "14.09", "07617": "14.10", "07633": "14.10", "07641": "14.11", "07676": "14.12",
            "07684": "14.03", "07685": "14.01", "07692": "14.01", "07765": "3.01", "07773": "3.02", "07774": "3.02", "07790": "3.03",
            "07803": "3.04", "07811": "11.01", "07838": "11.01", "07846": "11.01", "07854": "11.01", "07870": "11.02", "07889": "11.02",
            "07897": "11.03", "07919": "11.03", "07927": "11.04", "07930": "11.05", "07931": "11.05", "07951": "20.01", "07960": "20.02",
            "07978": "20.03", "08036": "3.01", "08037": "3.02", "08038": "3.03", "08040": "3.04", "08041": "11.01", "08042": "11.02",
            "08043": "11.03", "08044": "11.04", "08045": "11.05", "08046": "12.01", "08047": "12.02", "08048": "12.03", "08049": "12.04",
            "08050": "12.05", "08051": "12.06", "08052": "12.07", "08053": "12.08", "08054": "12.09", "08055": "12.10", "08056": "12.11",
            "08057": "12.12", "08058": "12.14", "08059": "12.15", "08060": "12.16", "08061": "12.17", "08062": "20.01", "08063": "20.02",
            "08064": "20.03", "08077": "7.02", "08078": "7.02", "08079": "7.04", "08080": "7.05", "08081": "7.09", "08082": "7.11",
            "08083": "7.17", "08084": "7.18", "08085": "14.02", "08086": "14.06", "08087": "17.03", "08088": "17.08", "08089": "17.16",
            "08090": "22.01", "08091": "27.01", "08092": "30.01", "08093": "31.01", "08094": "32.01", "08095": "36.01", "08096": "38.01",
            "08201": "1.01", "08202": "1.02", "08203": "1.03", "08204": "1.04", "08205": "1.05", "08206": "1.06", "08207": "1.07",
            "08208": "1.08", "08209": "2.01", "08210": "17.01", "08211": "17.02", "08212": "17.06", "08213": "17.11", "08214": "17.12",
            "08215": "17.13", "08216": "17.14", "08217": "17.15", "08218": "17.17", "08219": "17.18", "08220": "17.19", "08221": "17.20",
            "08222": "17.22", "08223": "17.23", "08224": "17.24", "08225": "21.01", "08226": "23.01", "08227": "26.01", "08228": "29.01",
            "08229": "35.01", "08230": "4.01", "08231": "4.02", "08232": "4.03", "08233": "4.04", "08234": "4.05", "08235": "4.06",
            "08236": "4.07", "08237": "4.08", "08238": "4.09", "08239": "4.10", "08240": "4.11", "08241": "4.12", "08242": "4.13",
            "08243": "4.14", "08244": "4.15", "08245": "4.16", "08246": "4.17", "08247": "4.18", "08248": "4.19", "08249": "4.20",
            "08250": "4.21", "08251": "4.22", "08252": "4.23", "08253": "5.01", "08254": "5.02", "08255": "5.03", "08256": "5.04",
            "08257": "5.05", "08258": "5.06", "08259": "5.07", "08260": "5.08", "08261": "5.09", "08262": "6.01", "08263": "6.02",
            "08264": "6.03", "08265": "6.04", "08266": "6.05", "08267": "8.01", "08268": "8.02", "08269": "15.01", "08270": "15.02",
            "08271": "15.03", "08272": "15.04", "08273": "15.05", "08274": "15.06", "08275": "15.07", "08276": "15.08", "08277": "15.10",
            "08278": "15.10", "08279": "15.11", "08280": "15.12", "08281": "15.13", "08282": "15.14", "08283": "15.15", "08284": "15.16",
            "08285": "15.17", "08286": "15.18", "08287": "18.01", "08288": "10.01", "08289": "10.02", "08290": "10.03", "08291": "10.04",
            "08292": "10.05", "08293": "10.06", "08294": "10.07", "08295": "10.08", "08296": "10.09", "08297": "10.10", "08298": "17.04",
            "08299": "17.05", "08300": "17.07", "08301": "17.09", "08302": "17.10", "08303": "17.21", "08304": "25.01", "08305": "25.02",
            "08306": "25.03", "08307": "25.04", "08308": "33.01", "08309": "9.01", "08310": "9.02", "08311": "9.03", "08312": "12.01",
            "08313": "12.02", "08314": "12.03", "08315": "12.04", "08316": "12.05", "08317": "12.06", "08318": "12.07", "08319": "12.08",
            "08320": "12.09", "08321": "12.10", "08322": "12.11", "08323": "12.12", "08324": "12.13", "08325": "12.14", "08326": "12.15",
            "08327": "12.16", "08328": "12.17", "08329": "24.01", "08330": "14.01", "08331": "14.03", "08332": "14.04", "08333": "14.05",
            "08334": "14.06", "08335": "14.07", "08336": "14.08", "08337": "14.09", "08338": "14.10", "08339": "14.11", "08340": "14.12",
            "08341": "3.01", "08342": "3.02", "08343": "3.03", "08344": "3.04", "08345": "11.01", "08346": "11.02", "08347": "11.03",
            "08348": "11.04", "08349": "20.01", "08350": "20.02", "08351": "20.03", "08432": "37.01", "08440": "39.01", "08467": "40.01",
            "08483": "40.01", "08505": "19.01", "08513": "19.01", "08521": "7.02", "08530": "14.06", "08548": "34.01", "08564": "34.01",
            "08572": "34.01", "08599": "37.01", "08602": "37.01", "08629": "39.01", "08637": "39.01", "08645": "39.01", "08653": "40.01",
            "08661": "40.01", "08670": "40.01", "08793": "19.01", "08807": "19.01", "08815": "19.01", "08823": "19.01", "08831": "19.01",
            "08858": "19.01", "08866": "19.01", "08874": "19.01", "08882": "19.01", "08890": "19.01", "08904": "19.01", "08912": "19.01",
            "08920": "19.01", "08939": "19.01", "08947": "19.01", "08955": "19.01", "08963": "19.01", "08971": "19.01", "09005": "6.01",
            "09013": "6.02", "09021": "6.03", "09030": "6.05", "3.05": "3.05", "7.21": "7.21", "7.22": "7.22", "14.14": "14.14",
            "16.02": "16.02", "17.25": "17.25", "25.05": "25.05"
        };
        const mapaTributacao = { "C": "5", "F": "6", "I": "3", "J": "4", "M": "1", "N": "2", "X": "7", "V": "7" };

        // --- Funções de UI e Eventos ---

        /** Adiciona uma mensagem ao log na tela. */
        function log(message, type = 'info') {
            const colors = {
                info: 'text-gray-600',
                error: 'text-red-600 font-bold',
                success: 'text-green-600 font-bold'
            };
            const logEntry = document.createElement('p');
            logEntry.className = colors[type];
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logMessagesDiv.appendChild(logEntry);
            logMessagesDiv.scrollTop = logMessagesDiv.scrollHeight;
        }
        
        // --- Funções Utilitárias ---
        
        function normalizeName(name) {
            if (!name) return '';
            let normalized = name.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            normalized = normalized.replace(/[^a-zA-Z0-9\s.,/&-]/g, '');
            return normalized.toUpperCase();
        }

        function simplifyServiceDescription(desc) {
            if (!desc) return "Não especificado";
            let simplified = desc.replace(/[^\p{L}\p{N}\p{P}\p{Z}^$]/gu, ' ')
                                 .toUpperCase()
                                 .normalize('NFD')
                                 .replace(/[\u0300-\u036f]/g, '')
                                 .replace(/<BR\s*\/?>/gi, ' ');
            if (simplified.includes('ASSESSORIA DE ABATE')) return 'ASSESSORIA DE ABATE';
            if (simplified.includes('SERVICO TECNICO') && simplified.includes('ACOMPANHAMENTO')) return 'ACOMPANHAMENTO TECNICO';
            if (simplified.includes('SERVICO TECNICO ESPECIALIZADO')) return 'SERVICO TECNICO ESPECIALIZADO';
            return simplified.replace(/REALIZADA\(S\)? EM \d+ ANIMAIS.*/, '')
                             .replace(/NO MES DE.*/, '').replace(/PERIODO DE.*/, '')
                             .replace(/FAZENDA[:\s].*/, '').replace(/SITIO[:\s].*/, '')
                             .replace(/IE[:\s].*/, '').replace(/\s+/g, ' ').trim().substring(0, 60);
        }

        const readFileAsText = (file, encoding = 'UTF-8') => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.onerror = (error) => reject(error);
            reader.readAsText(file, encoding);
        });
        
        const getNodeText = (parentNode, selector, defaultValue = "") => {
            const node = parentNode.querySelector(selector);
            return node ? node.textContent.trim() : defaultValue;
        }
        
        function safeParseFloat(value) {
            if (typeof value !== 'string') value = String(value || '0');
            value = value.trim();
            if (!value) return 0;

            const hasComma = value.indexOf(',') !== -1;
            const hasDot = value.indexOf('.') !== -1;

            if (hasComma && !hasDot) {
                // 123,45 -> 123.45 (PT-BR)
                return parseFloat(value.replace(',', '.'));
            }
            if (hasComma && hasDot) {
                if (value.lastIndexOf('.') < value.lastIndexOf(',')) {
                    // 1.234,56 (PT-BR) -> Remove dots, replace comma
                    return parseFloat(value.replace(/\./g, '').replace(',', '.'));
                } else {
                    // 1,234.56 (EN-US with separator) -> Remove commas
                    return parseFloat(value.replace(/,/g, ''));
                }
            }
            // 123.45 (EN-US simple) or 123 (Int)
            return parseFloat(value);
        }

       const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function convertToAbrasfDate(dataOriginal) {
            if (!dataOriginal || dataOriginal.startsWith("0000")) return "";
            try {
                let date;
                // Formato YYYY-MM-DD (com ou sem T HH:mm:ss)
                if (dataOriginal.includes('-')) {
                    date = new Date(dataOriginal.replace(" ", "T").substring(0, 19) + 'Z');
                } 
                // Formato DD/MM/YYYY (com ou sem HH:mm:ss)
                else if (dataOriginal.includes('/')) {
                    const parts = dataOriginal.match(/(\d{2})\/(\d{2})\/(\d{4})(?:[ T](\d{2}):(\d{2}):(\d{2}))?/);
                    if (parts) {
                        const [, day, month, year, hour = '00', minute = '00', second = '00'] = parts;
                        date = new Date(Date.UTC(year, month - 1, day, hour, minute, second));
                    }
                }
                return date && !isNaN(date.getTime()) ? date.toISOString().slice(0, 19) : "";
            } catch (e) {
                console.error("Erro ao converter data:", dataOriginal, e);
                return "";
            }
        }
        
        const escapeXML = (text) => {
            if (typeof text !== 'string') return '';
            return text.replace(/[<>&"']/g, c => ({'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'":'&apos;'}[c]));
        }

        function extrairMesReferencia(notas) {
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            for (const nota of notas) {
                const dateString = nota.dataEmissao || nota.competencia;
                if (!dateString) continue;
                try {
                    let date;
                    if (dateString.includes('-')) {
                        date = new Date(dateString.substring(0, 19) + 'Z');
                    } else if (dateString.includes('/')) {
                        const parts = dateString.split(' ')[0].split('/');
                        if (parts.length === 3) date = new Date(Date.UTC(parts[2], parts[1] - 1, parts[0]));
                    }
                    if (date && !isNaN(date.getTime())) {
                        return `${meses[date.getUTCMonth()]}/${date.getUTCFullYear()}`;
                    }
                } catch (e) { console.warn(`Could not parse date: ${dateString}`, e); }
            }
            return "N/A";
        }

        /** Busca dados do CNPJ na Brasil API e preenche os campos */
        async function handleCnpjBlur() {
            const cnpj = cnpjInput.value.replace(/\D/g, '');
            if (cnpj.length !== 14) return;

            resultadosDiv.classList.remove('hidden');
            log(`Buscando dados para o CNPJ: ${cnpj}...`, 'info');
            [cnpjInput, imEmpresaInput, ufEmpresaSelect, municipioEmpresaInput].forEach(el => el.disabled = true);

            try {
                const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                if (!response.ok) throw new Error(`CNPJ não encontrado ou API indisponível (Status: ${response.status})`);
                
                const data = await response.json();
                dadosEmpresaPrestadora = data;

                razaoSocialEmpresaInput.value = dadosEmpresaPrestadora.razao_social;
                const uf = dadosEmpresaPrestadora.uf;
                const municipio = dadosEmpresaPrestadora.municipio;

                if (uf && codigosPorUF[uf]) {
                    ufEmpresaSelect.value = uf;
                    ufEmpresaSelect.dispatchEvent(new Event('change'));
                    
                    const normalizedMunicipioAPI = normalizeForLookup(municipio);
                    const matchingMunicipio = codigosPorUF[uf].find(m => m.normalized === normalizedMunicipioAPI);
                    
                    municipioEmpresaInput.value = matchingMunicipio ? matchingMunicipio.original : municipio;
                    if (!matchingMunicipio) log(`Município "${municipio}" não corresponde exatamente à lista IBGE. Verifique a grafia.`, 'error');

                    log(`Dados da empresa preenchidos via Brasil API.`, 'success');
                } else {
                    throw new Error(`UF "${uf}" retornada pela API não é válida.`);
                }
            } catch (error) {
                log(`Erro ao consultar CNPJ: ${error.message}`, 'error');
                dadosEmpresaPrestadora = null;
                razaoSocialEmpresaInput.value = '';
                ufEmpresaSelect.value = '';
                atualizarMunicipios('');
            } finally {
                [cnpjInput, imEmpresaInput, ufEmpresaSelect, municipioEmpresaInput].forEach(el => el.disabled = false);
                razaoSocialEmpresaInput.disabled = true;
                if (!ufEmpresaSelect.value) municipioEmpresaInput.disabled = true;
                updateProcessarBtnState();
            }
        }

        /** Calcula a distância de Levenshtein entre duas strings. */
        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = Array.from(Array(b.length + 1), () => Array(a.length + 1).fill(0));
            for (let i = 0; i <= b.length; i++) matrix[i][0] = i;
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    const cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i - 1][j - 1] + cost, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
                }
            }
            return matrix[b.length][a.length];
        }

        /** Normaliza uma string para busca, removendo acentos, espaços e caracteres especiais. */
        function normalizeForLookup(text) {
            if (!text) return "";
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[ '-./()]/g, "");
        }

        /** Encontra o código IBGE para uma cidade e UF, com tolerância a pequenas diferenças. */
        function findIBGECode(cidade, uf) {
            if (!cidade || !uf) return '9999999';
            const cidadeTratada = cidade.replace(/\s*\([^)]*\)/, '').trim();
            const ufUpper = uf.toUpperCase();
            const normalizedKey = normalizeForLookup(`${cidadeTratada}|${ufUpper}`);
            if (normalizedCodigosIBGE[normalizedKey]) return normalizedCodigosIBGE[normalizedKey];
            const cidadesDaUF = codigosPorUF[ufUpper];
            if (cidadesDaUF) {
                const normalizedCidadeInput = normalizeForLookup(cidadeTratada);
                let bestMatch = null;
                let minDistance = Infinity;
                for (const cidadeInfo of cidadesDaUF) {
                    const distance = levenshteinDistance(normalizedCidadeInput, cidadeInfo.normalized);
                    if (distance < minDistance) {
                        minDistance = distance;
                        bestMatch = cidadeInfo;
                    }
                    if (minDistance === 0) break;
                }
                if (bestMatch && minDistance <= 2) {
                    normalizedCodigosIBGE[normalizedKey] = bestMatch.code;
                    log(`Código IBGE para "${cidade} - ${uf}" encontrado por aproximação como "${bestMatch.original}".`, 'info');
                    return bestMatch.code;
                }
            }
            log(`Código IBGE não encontrado para "${cidade} - ${uf}".`, 'error');
            return '9999999';
        }

        /** Atualiza a lista de municípios com base na UF selecionada. */
        function atualizarMunicipios(uf) {
            municipioEmpresaInput.value = '';
            municipiosList.innerHTML = '';
            if (uf && codigosPorUF[uf]) {
                municipioEmpresaInput.disabled = false;
                codigosPorUF[uf].sort((a, b) => a.original.localeCompare(b.original)).forEach(cidadeInfo => {
                    const option = document.createElement('option');
                    option.value = cidadeInfo.original;
                    municipiosList.appendChild(option);
                });
            } else {
                municipioEmpresaInput.disabled = true;
            }
        }

        // --- Carregamento e Pré-processamento de Dados ---
        async function carregarDadosMunicipios() {
            try {
                const response = await fetch('./municipios.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                codigosIBGE = await response.json();
                
                for (const key in codigosIBGE) {
                    const [cidade, uf] = key.split('|');
                    if (!cidade || !uf) continue;
                    const code = codigosIBGE[key];
                    if (code && code !== '0') reverseCodigosIBGE[code] = { cidade, uf };
                    const normalizedKey = normalizeForLookup(key);
                    normalizedCodigosIBGE[normalizedKey] = code;
                    if (!codigosPorUF[uf]) codigosPorUF[uf] = [];
                    codigosPorUF[uf].push({ original: cidade, normalized: normalizeForLookup(cidade), code: code });
                }
                
                const ufs = Object.keys(codigosPorUF).sort();
                ufs.forEach(uf => {
                    const option = document.createElement('option');
                    option.value = uf;
                    option.textContent = uf;
                    ufEmpresaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Falha ao carregar municipios.json:', error);
                log('Erro crítico: Não foi possível carregar os dados dos municípios.', 'error');
            }
        }
        
        await carregarDadosMunicipios();
        
        /** Atualiza o estado do botão "Processar Arquivos" */
        function updateProcessarBtnState() {
            const cnpjValido = cnpjInput.value.replace(/\D/g, '').length === 14;
            // imValida removido da validação obrigatória
            const ufValida = ufEmpresaSelect.value !== '';
            const municipioValido = municipioEmpresaInput.value.trim() !== '';
            const modoValido = modoGeracaoEscolhido !== null;
            const arquivosValidos = arquivosSelecionados.length > 0;
            const competenciaValida = activeTab !== 'pdf' || (competenciaMesSelect.value !== '' && competenciaAnoInput.value !== '');
            
            processarBtn.disabled = !(cnpjValido && ufValida && municipioValido && modoValido && arquivosValidos && competenciaValida);
        }

        /** Atualiza a lista de arquivos exibida na UI */
        function updateFileList() {
            fileListDiv.innerHTML = '';
            arquivosSelecionados.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `<span class="file-item-name text-sm text-gray-700">${file.name}</span><button onclick="window.removerArquivo(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl leading-none">&times;</button>`;
                fileListDiv.appendChild(fileItem);
            });
            updateProcessarBtnState();
        }
        
        /** Remove um arquivo da lista de seleção (exposto globalmente para o onclick) */
        window.removerArquivo = (index) => {
            arquivosSelecionados.splice(index, 1);
            updateFileList();
        }

        /** Manipula a adição de novos arquivos */
        function handleFiles(files) {
            arquivosSelecionados = [...arquivosSelecionados, ...Array.from(files)];
            updateFileList();
        }

        /** Muda a aba ativa (XML, TXT, PDF) */
        function switchTab(tab) {
            activeTab = tab;
            arquivosSelecionados = [];
            updateFileList();
            [tabXmlBtn, tabTxtBtn, tabPdfBtn].forEach(btn => btn.classList.toggle('active', btn.id === `tab-${tab}`));
            uploadXmlArea.classList.toggle('hidden', tab !== 'xml');
            uploadTxtArea.classList.toggle('hidden', tab !== 'txt');
            uploadPdfArea.classList.toggle('hidden', tab !== 'pdf');
            competenciaPdfSection.style.display = tab === 'pdf' ? 'grid' : 'none';
            updateProcessarBtnState();
        }
        
        /** Prepara os listeners de drag and drop */
        function setupDragDrop(area, input) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => area.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(ev => area.addEventListener(ev, () => area.classList.add('drag-over')));
            ['dragleave', 'drop'].forEach(ev => area.addEventListener(ev, () => area.classList.remove('drag-over')));
            area.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
            input.addEventListener('change', (e) => handleFiles(e.target.files));
        }

        /** Cria e faz o download de um arquivo ZIP, e exibe o link na UI */
        async function downloadZip(filename, files) {
            if (files.length === 0) {
                log('Nenhum arquivo para incluir no ZIP.', 'error');
                return;
            }
            const zip = new JSZip();
            files.forEach(file => zip.file(file.name, file.content));
            const content = await zip.generateAsync({ type: "blob" });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.textContent = `Download do ZIP: ${files.length} arquivos`;
            link.className = 'block w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition';
            downloadLinksDiv.appendChild(link);
            log(`Arquivo ZIP "${filename}" gerado e pronto para download.`, 'success');
        }
        
        // --- Funções de Parsing para um Objeto Canônico ---

        function mapearXmlParaPadronizado(doc, config) {
            if (doc.querySelector('CompNfse > Nfse > InfNfse')) {
                log(`Processando XML (padrão NFS-e ABRASF)`, 'info');
                return [mapearCompNfse(doc.querySelector('InfNfse'), config)];
            } 
            if (doc.querySelector('nfe > NotaFiscal')) {
                log(`Processando XML (padrão Artur Nogueira-SP)`, 'info');
                return Array.from(doc.querySelectorAll('nfe > NotaFiscal')).map(node => mapearArturNogueira(node, config)).filter(Boolean);
            }
            if (doc.querySelector('NOTA_FISCAL')) { // Campo Grande-MS
                 log(`Processando XML (padrão Campo Grande-MS)`, 'info');
                return [mapearCampoGrande(doc.querySelector('NOTA_FISCAL'), config)];
            }
            throw new Error("Formato de XML não suportado ou não reconhecido.");
        }

        function mapearCompNfse(infNfse, config) {
            const declaracao = infNfse.parentElement.querySelector('DeclaracaoPrestacaoServico > InfDeclaracaoPrestacaoServico');
            if (!declaracao) return null;

            const prestadorNode = infNfse.querySelector('PrestadorServico');
            const tomadorNode = declaracao.querySelector('Tomador');
            const servicoNode = declaracao.querySelector('Servico');
            const valoresServicoNode = servicoNode.querySelector('Valores');
            const tomadorCpfCnpj = tomadorNode.querySelector('IdentificacaoTomador > CpfCnpj');
            const tomadorEnd = tomadorNode.querySelector('Endereco');
            const prestadorEnd = prestadorNode.querySelector('Endereco');

            // Ajuste na leitura da alíquota para suportar decimal (0.025) e percentual (2.5)
            // Se for < 1 (ex: 0.025), multiplica por 100. Se for > 1 (ex: 2.5), mantém.
            const rawAliquota = safeParseFloat(getNodeText(valoresServicoNode, 'Aliquota'));
            const aliquota = (rawAliquota > 0 && rawAliquota < 1) ? rawAliquota * 100 : rawAliquota;

            return {
                numero: getNodeText(infNfse, 'Numero'),
                codigoVerificacao: getNodeText(infNfse, 'CodigoVerificacao'),
                dataEmissao: getNodeText(infNfse, 'DataEmissao').split('T')[0],
                competencia: getNodeText(declaracao, 'Competencia'),
                discriminacao: getNodeText(servicoNode, 'Discriminacao'),
                situacao: 'NORMAL',
                valorServico: safeParseFloat(getNodeText(valoresServicoNode, 'ValorServicos')),
                valorDeducao: safeParseFloat(getNodeText(valoresServicoNode, 'ValorDeducoes')),
                valorPis: safeParseFloat(getNodeText(valoresServicoNode, 'ValorPis')),
                valorCofins: safeParseFloat(getNodeText(valoresServicoNode, 'ValorCofins')),
                valorInss: safeParseFloat(getNodeText(valoresServicoNode, 'ValorInss')),
                valorIr: safeParseFloat(getNodeText(valoresServicoNode, 'ValorIr')),
                valorCsll: safeParseFloat(getNodeText(valoresServicoNode, 'ValorCsll')),
                issRetido: getNodeText(valoresServicoNode, 'IssRetido', '2'),
                valorIss: safeParseFloat(getNodeText(valoresServicoNode, 'ValorIss')),
                valorIssRetido: safeParseFloat(getNodeText(valoresServicoNode, 'ValorIssRetido')),
                aliquota: aliquota,
                itemLista: getNodeText(servicoNode, 'ItemListaServico'),
                codigoTributacaoMunicipio: getNodeText(servicoNode, 'CodigoTributacaoMunicipio'),
                codCnae: getNodeText(servicoNode, 'CodigoCnae'),
                codMunPrestacao: getNodeText(servicoNode, 'MunicipioIncidencia'),
                prestacaoLocal: `${reverseCodigosIBGE[getNodeText(servicoNode, 'MunicipioIncidencia')]?.cidade || ''} - ${reverseCodigosIBGE[getNodeText(servicoNode, 'MunicipioIncidencia')]?.uf || ''}`,
                exigibilidadeISS: getNodeText(servicoNode, 'ExigibilidadeISS', '1'),
                optanteSimples: getNodeText(declaracao, 'OptanteSimplesNacional', '2'),
                prestadorCnpj: getNodeText(prestadorNode, 'IdentificacaoPrestador > CpfCnpj > Cnpj'),
                prestadorIM: getNodeText(prestadorNode, 'IdentificacaoPrestador > InscricaoMunicipal'),
                prestadorRazao: normalizeName(getNodeText(prestadorNode, 'RazaoSocial')),
                prestadorCodMun: getNodeText(prestadorEnd, 'CodigoMunicipio'),
                prestadorUF: getNodeText(prestadorEnd, 'Uf'),
                tomadorDoc: getNodeText(tomadorCpfCnpj, 'Cnpj') || getNodeText(tomadorCpfCnpj, 'Cpf'),
                tomadorRazao: normalizeName(getNodeText(tomadorNode, 'RazaoSocial')),
                tomadorEnd: getNodeText(tomadorEnd, 'Endereco'),
                tomadorNum: getNodeText(tomadorEnd, 'Numero'),
                tomadorComp: getNodeText(tomadorEnd, 'Complemento'),
                tomadorBairro: getNodeText(tomadorEnd, 'Bairro'),
                tomadorCodMun: getNodeText(tomadorEnd, 'CodigoMunicipio'),
                tomadorUF: getNodeText(tomadorEnd, 'Uf'),
                tomadorCEP: getNodeText(tomadorEnd, 'Cep'),
                tomadorEmail: getNodeText(tomadorNode, 'Contato > Email'),
            };
        }

        function mapearArturNogueira(notaNode, config) {
            if (getNodeText(notaNode, 'NfeCabecario > notacancelada') === '1') {
                log(`Ignorando Nota Fiscal nº ${getNodeText(notaNode, 'NfeCabecario > numeroNota')} por estar cancelada.`, 'info');
                return null;
            }

            const tomadorDoc = getNodeText(notaNode, 'DadosTomador > documento').replace(/\D/g, '');
            const dataEmissaoParts = getNodeText(notaNode, 'NfeCabecario > dataEmissao').split('/');
            const dataEmissao = `${dataEmissaoParts[2]}-${dataEmissaoParts[1]}-${dataEmissaoParts[0]}`;
            const codServicoRaw = getNodeText(notaNode, 'DetalhesServico > codigo');
            let itemListaServico;
            switch(codServicoRaw) {
                case '403': itemListaServico = '4.03'; break;
                default: itemListaServico = '01.07'; break;
            }
            
            const prestadorUF = getNodeText(notaNode, 'DadosPrestador > uf');
            
            // Novos campos solicitados para retenções e ISS, buscando em todo o nó da nota caso a estrutura varie
            // Prioridade para DetalhesServico mas com fallback
            const getVal = (tag) => safeParseFloat(getNodeText(notaNode, `DetalhesServico > ${tag}`) || getNodeText(notaNode, tag));

            const valorServico = getVal('valorServico');
            const valorPIS = getVal('pispasep');
            const valorCOFINS = getVal('cofins');
            const valorINSS = getVal('inss');
            const valorIR = getVal('ir');
            const valorCSLL = getVal('csll');
            
            const valorIss = getVal('valorIss');
            const aliquota = getVal('aliquota');
            const issRetidoRaw = getNodeText(notaNode, 'DetalhesServico > issretido') || getNodeText(notaNode, 'issretido');
            const isRetido = issRetidoRaw === '1';
            const issRetido = isRetido ? '1' : '2';
            const valorIssRetido = isRetido ? valorIss : 0; 

            // Lógica de Local da Prestação baseada em <outromunicipio>
            const outroMunicipio = getNodeText(notaNode, 'DetalhesServico > outromunicipio') || getNodeText(notaNode, 'outromunicipio');
            // 1 = Prestado no município (Prestador)
            // 2 = Prestado em outro município
            
            // Dados do Tomador para identificar local se for fora
            const tomadorCidade = getNodeText(notaNode, 'DadosTomador > cidade');
            const tomadorUF = getNodeText(notaNode, 'DadosTomador > uf');
            const tomadorCodMun = findIBGECode(tomadorCidade, tomadorUF);
            
            let codMunPrestacao = config.codMunEmpresa;
            let prestacaoLocal = `${config.municipioEmpresa} - ${config.ufEmpresa}`;

            if (outroMunicipio === '2') {
                codMunPrestacao = tomadorCodMun;
                prestacaoLocal = `${tomadorCidade} - ${tomadorUF}`;
            }

            return {
                numero: getNodeText(notaNode, 'NfeCabecario > numeroNota'),
                codigoVerificacao: getNodeText(notaNode, 'NfeCabecario > codigoVerificacao'),
                dataEmissao: dataEmissao,
                competencia: dataEmissao,
                discriminacao: getNodeText(notaNode, 'DetalhesServico > descricao'),
                situacao: 'NORMAL',
                valorServico: valorServico,
                valorDeducao: 0, 
                valorPis: valorPIS, 
                valorCofins: valorCOFINS, 
                valorInss: valorINSS, 
                valorIr: valorIR, 
                valorCsll: valorCSLL, 
                valorIss: valorIss,
                issRetido: issRetido,
                valorIssRetido: valorIssRetido,
                aliquota: aliquota,
                itemLista: itemListaServico,
                codigoTributacaoMunicipio: codServicoRaw,
                codMunPrestacao: codMunPrestacao,
                prestacaoLocal: prestacaoLocal,
                exigibilidadeISS: '1',
                optanteSimples: getNodeText(notaNode, 'NfeCabecario > optIncentivoFiscal').includes('Não') ? '2' : '1',
                prestadorCnpj: getNodeText(notaNode, 'DadosPrestador > documento').replace(/\D/g, ''),
                prestadorIM: getNodeText(notaNode, 'DadosPrestador > inscricaoMunicipal'),
                prestadorRazao: normalizeName(getNodeText(notaNode, 'DadosPrestador > razaoSocial')),
                prestadorCodMun: findIBGECode(getNodeText(notaNode, 'DadosPrestador > cidade'), prestadorUF),
                prestadorUF: prestadorUF,
                tomadorDoc: tomadorDoc,
                tomadorRazao: normalizeName(getNodeText(notaNode, 'DadosTomador > razaoSocial')),
                tomadorEnd: getNodeText(notaNode, 'DadosTomador > logradouro'),
                tomadorNum: getNodeText(notaNode, 'DadosTomador > numero'),
                tomadorComp: getNodeText(notaNode, 'DadosTomador > complemento'),
                tomadorBairro: getNodeText(notaNode, 'DadosTomador > bairro'),
                tomadorCodMun: tomadorCodMun,
                tomadorUF: tomadorUF,
                tomadorCEP: getNodeText(notaNode, 'DadosTomador > cep').replace(/\D/g, ''),
                tomadorEmail: getNodeText(notaNode, 'DadosTomador > email'),
            };
        }

        function mapearCampoGrande(notaNode, config) {
            const prestacaoCidade = getNodeText(notaNode, 'CIDADE_PRESTACAO');
            const prestacaoUf = getNodeText(notaNode, 'UF_PRESTACAO');
            const codMunPrestacao = findIBGECode(prestacaoCidade, prestacaoUf);
            const issRetidoCG = safeParseFloat(getNodeText(notaNode, "VALOR_ISS_RET", "0"));

            return {
                numero: getNodeText(notaNode, "NUM_NOTA"),
                codigoVerificacao: getNodeText(notaNode, "CODIGO_VERIFICACAO"),
                dataEmissao: getNodeText(notaNode, "DATA_HORA_EMISSAO"),
                dataCancelamento: getNodeText(notaNode, 'DATA_HORA_CANCELAMENTO', ''),
                discriminacao: getNodeText(notaNode, "DESCRICAO_NOTA"),
                valorServico: safeParseFloat(getNodeText(notaNode, "VALOR_SERVICO")),
                aliquota: safeParseFloat(getNodeText(notaNode, "ALIQUOTA")),
                valorIss: safeParseFloat(getNodeText(notaNode, "VALOR_ISS")),
                prestadorCnpj: getNodeText(notaNode, 'PRESTADOR_CPF_CNPJ').replace(/\D/g, ''),
                prestadorIM: getNodeText(notaNode, "PRESTADOR_INSCRICAO_MUNICIPAL"),
                prestadorRazao: normalizeName(getNodeText(notaNode, "PRESTADOR_RAZAO_SOCIAL")),
                prestadorCodMun: findIBGECode(getNodeText(notaNode, 'PRESTADOR_CIDADE'), getNodeText(notaNode, 'PRESTADOR_UF')),
                prestadorUF: getNodeText(notaNode, 'PRESTADOR_UF'),
                competencia: getNodeText(notaNode, "MES_COMPETENCIA"),
                valorDeducao: safeParseFloat(getNodeText(notaNode, "VALOR_DEDUCAO", "0")),
                valorPIS: safeParseFloat(getNodeText(notaNode, "VALOR_PIS")),
                valorCOFINS: safeParseFloat(getNodeText(notaNode, "VALOR_COFINS")),
                valorINSS: safeParseFloat(getNodeText(notaNode, "VALOR_INSS")),
                valorIR: safeParseFloat(getNodeText(notaNode, "VALOR_IR")),
                valorCSLL: safeParseFloat(getNodeText(notaNode, "VALOR_CSLL")),
                issRetido: issRetidoCG > 0 ? "1" : "2",
                valorIssRetido: issRetidoCG,
                exigibilidadeISS: (config.codMunEmpresa === codMunPrestacao) ? "1" : "2",
                itemLista: mapaServicos[getNodeText(notaNode, "COS_SERVICO")] || getNodeText(notaNode, "COS_SERVICO"),
                codCnae: getNodeText(notaNode, "CODIGO_ATIVIDADE"),
                codMunPrestacao: codMunPrestacao,
                prestacaoLocal: `${prestacaoCidade} - ${prestacaoUf}`,
                tomadorDoc: getNodeText(notaNode, 'TOMADOR_CPF_CNPJ').replace(/\D/g, ''),
                tomadorRazao: normalizeName(getNodeText(notaNode, "TOMADOR_RAZAO_SOCIAL")),
                tomadorEnd: getNodeText(notaNode, "TOMADOR_LOGRADOURO"),
                tomadorNum: getNodeText(notaNode, "TOMADOR_NUMERO"),
                tomadorComp: getNodeText(notaNode, "TOMADOR_COMPLEMENTO"),
                tomadorBairro: getNodeText(notaNode, "TOMADOR_BAIRRO"),
                tomadorCodMun: findIBGECode(getNodeText(notaNode, 'TOMADOR_CIDADE'), getNodeText(notaNode, 'TOMADOR_UF')),
                tomadorUF: getNodeText(notaNode, 'TOMADOR_UF'),
                tomadorCEP: getNodeText(notaNode, "TOMADOR_CEP").replace(/\D/g, ''),
                tomadorEmail: getNodeText(notaNode, "TOMADOR_EMAIL"),
                optanteSimples: getNodeText(notaNode, "TRIBUTACAO_PRESTACAO") === "H" ? "1" : "2",
                situacao: getNodeText(notaNode, 'SITUACAO_NF').toUpperCase(),
            };
        }

        function mapearTxtPaulistana(fileText, config) {
            const linhas = fileText.split(/\r?\n/);
            const notas = [];
            
            log(`Lendo arquivo TXT...`, 'info');

            // Helper para parsear valores PT-BR (1.000,00)
            const parseTxtValue = (str) => {
                if (!str) return 0;
                const clean = str.trim();
                if (!clean) return 0;
                const normalized = clean.replace(/\./g, '').replace(',', '.');
                return parseFloat(normalized) || 0;
            };

            const isTabSeparated = fileText.indexOf('\t') !== -1;
            
            // --- Lógica de Mapeamento Dinâmico (Header) ---
            let colMap = {}; // Armazena 'Nome da Coluna' => Índice
            let hasHeader = false;
            let headerLength = 0;
            let repasseIndex = -1;

            // Analisa a primeira linha para ver se é cabeçalho
            if (linhas.length > 0) {
                const primeiraLinha = linhas[0].trim();
                // Verifica palavras-chave comuns no cabeçalho de SP
                if (primeiraLinha.includes("Nº NFS-e") || primeiraLinha.includes("Valor dos Serviços") || primeiraLinha.includes("Tipo de Registro")) {
                    hasHeader = true;
                    const headers = primeiraLinha.split('\t');
                    headerLength = headers.length;
                    headers.forEach((header, index) => {
                        // Normaliza o nome do header para evitar erros de encoding ou espaços extras
                        // Ex: "  PIS/PASEP  " vira "PIS/PASEP"
                        const key = header.trim(); 
                        colMap[key] = index;
                        
                        // Detecta o índice da coluna problemática "Repasse do Plano de Saúde"
                        if (key.includes("Repasse do Plano de Saúde")) {
                            repasseIndex = index;
                        }
                    });
                    log(`Cabeçalho detectado (${headerLength} colunas). Utilizando mapeamento dinâmico.`, 'success');
                } else {
                    log(`Arquivo sem cabeçalho explícito. Tentando mapeamento posicional padrão.`, 'info');
                }
            }

            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i];
                
                // Pula a linha do cabeçalho se ela foi detectada
                if (hasHeader && i === 0) continue;

                // Filtra linhas que começam com '2' (Registro de NF-e)
                if (!linha.startsWith('2')) continue;

                try {
                    let numero, dataEmissao, tomadorDoc, valorServico, valorDeducao, codServicoSP, aliquota, valorIss, issRetidoRaw, issRetido, valorIssRetido, discriminacao, prestadorIMArquivo;
                    let prestadorRazao = config.razaoSocialPrestador;
                    let prestadorCnpj = config.cnpjPrestador;
                    let prestadorUF = config.ufPrestador;
                    let prestadorCodMun = config.codMunEmpresa;
                    
                    let tomadorRazao = 'TOMADOR DIVERSOS';
                    let tomadorEnd = '', tomadorNum = '', tomadorComp = '', tomadorBairro = '', tomadorCidade = '', tomadorUF = '', tomadorCEP = '', tomadorEmail = '', tomadorIM = '';
                    let situacao = 'NORMAL';
                    let valorPis = 0, valorCofins = 0, valorInss = 0, valorIr = 0, valorCsll = 0;
                    let codigoVerificacao = '';

                    if (isTabSeparated) {
                        const cols = linha.split('\t');
                        
                        // Detecção de Deslocamento (Ghost Column "Repasse")
                        // Se o cabeçalho tem "Repasse" mas a linha atual tem 1 coluna a menos,
                        // assumimos que a coluna "Repasse" foi omitida nos dados e ajustamos o índice.
                        let shift = 0;
                        if (hasHeader && repasseIndex !== -1 && cols.length === headerLength - 1) {
                             shift = 1;
                        }

                        // Função auxiliar para buscar valor pela coluna (Nome) ou Índice (Fallback)
                        const getVal = (colNames, fallbackIndex) => {
                            if (hasHeader) {
                                // Aceita uma string ou array de strings (para variações de nome)
                                const names = Array.isArray(colNames) ? colNames : [colNames];
                                for (const name of names) {
                                    if (colMap.hasOwnProperty(name)) {
                                        let idx = colMap[name];
                                        
                                        // Aplica a correção de deslocamento se estivermos lendo colunas APÓS a coluna problemática (Repasse)
                                        if (shift > 0 && idx > repasseIndex) {
                                            idx = idx - shift;
                                        }
                                        
                                        return cols[idx];
                                    }
                                }
                            }
                            // Se não tiver cabeçalho ou a coluna não for encontrada no mapa, usa o índice fixo
                            return cols[fallbackIndex];
                        };
                        
                        // Mapeamento Dinâmico ou Fallback (índices baseados no layout padrão SP)
                        
                        numero = getVal(['Nº NFS-e', 'Numero'], 1)?.trim();
                        
                        const dataRaw = getVal(['Data Hora NFE', 'Data Emissão'], 2)?.trim(); 
                        if (dataRaw) {
                            const datePart = dataRaw.split(' ')[0]; 
                            const [d, m, y] = datePart.split('/');
                            dataEmissao = `${y}-${m}-${d}`;
                        }

                        codigoVerificacao = getVal(['Código de Verificação da NFS-e', 'Codigo Verificacao'], 3)?.trim();
                        prestadorIMArquivo = getVal(['Inscrição Municipal do Prestador', 'IM Prestador'], 8)?.trim();
                        
                        const prestadorDocRaw = getVal(['CPF/CNPJ do Prestador', 'CNPJ Prestador'], 10)?.trim().replace(/\D/g, '');
                        if (prestadorDocRaw) prestadorCnpj = prestadorDocRaw;
                        
                        const prestadorRazaoRaw = getVal(['Razão Social do Prestador', 'Razão Social Prestador'], 11)?.trim();
                        if (prestadorRazaoRaw) prestadorRazao = prestadorRazaoRaw;
                        
                        // Busca endereço do prestador para definir local
                        const prestadorCidade = getVal(['Cidade do Prestador', 'Cidade Prestador'], 17)?.trim();
                        const prestadorUFArquivo = getVal(['UF do Prestador', 'UF Prestador'], 18)?.trim();
                        
                        if (prestadorUFArquivo) prestadorUF = prestadorUFArquivo;
                        if (prestadorCidade && prestadorUFArquivo) {
                            prestadorCodMun = findIBGECode(prestadorCidade, prestadorUFArquivo);
                        }

                        const dataCancelamento = getVal(['Data de Cancelamento'], 23);
                        if (dataCancelamento && dataCancelamento.trim().length > 0) {
                            situacao = 'CANCELADA';
                        }

                        valorServico = parseTxtValue(getVal(['Valor dos Serviços', 'Valor Servico'], 26));
                        valorDeducao = parseTxtValue(getVal(['Valor das Deduções', 'Valor Deducoes'], 27));
                        codServicoSP = getVal(['Código do Serviço Prestado na Nota Fiscal', 'Codigo Servico'], 28)?.trim();
                        aliquota = parseTxtValue(getVal(['Alíquota', 'Aliquota'], 29));
                        valorIss = parseTxtValue(getVal(['ISS devido'], 30));
                        
                        issRetidoRaw = getVal(['ISS Retido'], 32)?.trim().toUpperCase(); 
                        issRetido = issRetidoRaw === 'S' ? '1' : '2';
                        valorIssRetido = issRetido === '1' ? valorIss : 0;

                        // Tomador
                        tomadorDoc = getVal(['CPF/CNPJ do Tomador', 'CNPJ Tomador'], 34)?.trim().replace(/\D/g, '');
                        tomadorIM = getVal(['Inscrição Municipal do Tomador'], 35)?.trim();
                        tomadorRazao = getVal(['Razão Social do Tomador'], 37)?.trim() || 'TOMADOR DIVERSOS';
                        
                        tomadorEnd = getVal(['Endereço do Tomador'], 39)?.trim();
                        tomadorNum = getVal(['Número do Endereço do Tomador'], 40)?.trim();
                        tomadorComp = getVal(['Complemento do Endereço do Tomador'], 41)?.trim();
                        tomadorBairro = getVal(['Bairro do Tomador'], 42)?.trim();
                        tomadorCidade = getVal(['Cidade do Tomador'], 43)?.trim();
                        tomadorUF = getVal(['UF do Tomador'], 44)?.trim();
                        tomadorCEP = getVal(['CEP do Tomador'], 45)?.trim();
                        tomadorEmail = getVal(['Email do Tomador'], 46)?.trim();

                        // Retenções Federais - O PULO DO GATO
                        // Se "Repasse do Plano de Saúde" existir ou não, não importa, ele vai achar "PIS/PASEP" onde estiver.
                        // Os índices de fallback (54, 55...) são mantidos para arquivos SEM cabeçalho.
                        
                        valorPis = parseTxtValue(getVal(['PIS/PASEP', 'PIS'], 54));
                        valorCofins = parseTxtValue(getVal(['COFINS'], 55));
                        valorInss = parseTxtValue(getVal(['INSS'], 56));
                        valorIr = parseTxtValue(getVal(['IR'], 57));
                        valorCsll = parseTxtValue(getVal(['CSLL'], 58));

                        // Discriminação
                        discriminacao = getVal(['Discriminação dos Serviços', 'Discriminacao'], cols.length - 1)?.trim();

                    } else {
                        // Lógica Posicional Antiga (Mantida apenas para layout posicional estrito sem tabs)
                        numero = linha.substring(1, 9).trim();
                        const dataRaw = linha.substring(9, 17).trim(); 
                        if (dataRaw.length === 8) {
                            dataEmissao = `${dataRaw.substring(0,4)}-${dataRaw.substring(4,6)}-${dataRaw.substring(6,8)}`;
                        }
                        tomadorDoc = linha.substring(31, 45).trim();
                        valorServico = parseInt(linha.substring(90, 105)) / 100;
                        valorDeducao = parseInt(linha.substring(105, 120)) / 100;
                        codServicoSP = linha.substring(120, 125).trim();
                        aliquota = parseInt(linha.substring(125, 129)) / 100;
                        valorIss = parseInt(linha.substring(129, 144)) / 100;
                        issRetidoRaw = linha.substring(144, 145);
                        issRetido = issRetidoRaw === '1' ? '1' : '2';
                        valorIssRetido = issRetido === '1' ? valorIss : 0;
                        prestadorIMArquivo = linha.substring(145, 153).trim();
                        discriminacao = linha.substring(165).trim();
                    }

                    const itemLista = mapaServicos[codServicoSP] || mapaServicos[codServicoSP.padStart(5, '0')] || codServicoSP;
                    const tomadorCodMun = findIBGECode(tomadorCidade, tomadorUF);

                    notas.push({
                        numero: numero,
                        codigoVerificacao: codigoVerificacao,
                        dataEmissao: dataEmissao,
                        competencia: dataEmissao,
                        discriminacao: discriminacao,
                        situacao: situacao,
                        valorServico: valorServico,
                        valorDeducao: valorDeducao,
                        valorPis: valorPis,
                        valorCofins: valorCofins,
                        valorInss: valorInss,
                        valorIr: valorIr,
                        valorCsll: valorCsll,
                        valorIss: valorIss,
                        issRetido: issRetido,
                        valorIssRetido: valorIssRetido,
                        aliquota: aliquota,
                        itemLista: itemLista,
                        codigoTributacaoMunicipio: codServicoSP,
                        codCnae: '',
                        codMunPrestacao: config.codMunEmpresa,
                        prestacaoLocal: `${config.municipioEmpresa} - ${config.ufEmpresa}`,
                        exigibilidadeISS: '1',
                        optanteSimples: '2', 
                        prestadorCnpj: prestadorCnpj,
                        prestadorIM: prestadorIMArquivo || config.inscricaoMunicipalPrestador,
                        prestadorRazao: prestadorRazao,
                        prestadorCodMun: prestadorCodMun,
                        prestadorUF: prestadorUF,
                        tomadorDoc: tomadorDoc,
                        tomadorIM: tomadorIM,
                        tomadorRazao: tomadorRazao,
                        tomadorEnd: tomadorEnd,
                        tomadorNum: tomadorNum,
                        tomadorComp: tomadorComp,
                        tomadorBairro: tomadorBairro,
                        tomadorCodMun: tomadorCodMun,
                        tomadorUF: tomadorUF,
                        tomadorCEP: tomadorCEP,
                        tomadorEmail: tomadorEmail
                    });
                } catch (e) {
                    console.warn("Erro ao ler linha TXT SP:", linha, e);
                }
            }
            return notas;
        }

        async function processarArquivo(file, config) {
            try {
                const encoding = activeTab === 'txt' ? 'ISO-8859-1' : 'UTF-8';
                const fileText = await readFileAsText(file, encoding);

                if (activeTab === 'xml') {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(fileText, "application/xml");
                    if (xmlDoc.getElementsByTagName("parsererror").length) throw new Error("Erro de sintaxe no XML.");
                    
                    const result = mapearXmlParaPadronizado(xmlDoc, config);
                    return Array.isArray(result) ? result : [result];
                }
                
                if (activeTab === 'txt') {
                    return mapearTxtPaulistana(fileText, config);
                }

                log(`Processador para a aba "${activeTab}" ainda não implementado.`, 'error');
                return [];

            } catch (e) {
                log(`Erro ao processar ${file.name}: ${e.message}`, 'error');
                return [];
            }
        }
        
        // --- Funções de Geração de Arquivos ---
        
        function gerarXML_CompNfse(nota, config) {
            try {
                const safeToFixed = (val) => (typeof val === 'number' && !isNaN(val)) ? val.toFixed(2) : '0.00';

                let outrasInfo = '';
                let descricaoPrincipal = nota.discriminacao || '';
                const tribAproxIndex = descricaoPrincipal.toLowerCase().indexOf("trib aprox");
                if (tribAproxIndex > -1) {
                    outrasInfo = descricaoPrincipal.substring(tribAproxIndex);
                    descricaoPrincipal = descricaoPrincipal.substring(0, tribAproxIndex).trim();
                }
                
                let competenciaFormatada = nota.competencia;
                if (competenciaFormatada && competenciaFormatada.includes('/')) {
                    const parts = competenciaFormatada.split(' ')[0].split('/');
                    if(parts.length === 3) competenciaFormatada = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                } else if (competenciaFormatada) {
                    competenciaFormatada = competenciaFormatada.split('T')[0];
                }
                
                // Cálculo do Valor Líquido = Serviço - Retenções
                let valorLiquido = (nota.valorServico || 0) - (nota.valorIr || 0) - (nota.valorPis || 0) - (nota.valorCofins || 0) - (nota.valorCsll || 0) - (nota.valorInss || 0) - (nota.valorIssRetido || 0) - (nota.valorDeducao || 0);

                // Determina os dados do prestador: usa os dados da nota se existirem, senão usa config (fallback)
                const pCnpj = nota.prestadorCnpj || config.cnpjPrestador;
                const pIM = nota.prestadorIM || config.inscricaoMunicipalPrestador;
                const pRazao = nota.prestadorRazao || config.razaoSocialPrestador;
                const pCodMun = nota.prestadorCodMun || config.codMunEmpresa;
                const pUF = nota.prestadorUF || config.ufPrestador;

                return `<CompNfse xmlns="http://www.abrasf.org.br/nfse.xsd">
    <Nfse versao="2.01">
        <InfNfse>
            <Numero>${nota.numero}</Numero>
            <CodigoVerificacao>${escapeXML(nota.codigoVerificacao)}</CodigoVerificacao>
            <DataEmissao>${convertToAbrasfDate(nota.dataEmissao)}</DataEmissao>
            ${outrasInfo ? `<OutrasInformacoes>${escapeXML(outrasInfo)}</OutrasInformacoes>` : ''}
            <ValoresNfse>
                <BaseCalculo>${safeToFixed(nota.valorServico)}</BaseCalculo>
                <Aliquota>${safeToFixed(nota.aliquota)}</Aliquota>
                <ValorIss>${safeToFixed(nota.valorIss)}</ValorIss>
                <ValorLiquidoNfse>${safeToFixed(valorLiquido)}</ValorLiquidoNfse>
            </ValoresNfse>
            <PrestadorServico>
                <IdentificacaoPrestador>
                    <CpfCnpj><Cnpj>${pCnpj}</Cnpj></CpfCnpj>
                    <InscricaoMunicipal>${pIM}</InscricaoMunicipal>
                </IdentificacaoPrestador>
                <RazaoSocial>${escapeXML(pRazao)}</RazaoSocial>
                <Endereco>
                    <CodigoMunicipio>${pCodMun}</CodigoMunicipio>
                    <Uf>${pUF}</Uf>
                </Endereco>
            </PrestadorServico>
            <OrgaoGerador>
                <CodigoMunicipio>${config.codMunEmpresa}</CodigoMunicipio>
                <Uf>${config.ufPrestador}</Uf>
            </OrgaoGerador>
            <DeclaracaoPrestacaoServico>
                <InfDeclaracaoPrestacaoServico>
                    <Competencia>${competenciaFormatada}</Competencia>
                    <Servico>
                        <Valores>
                            <ValorServicos>${safeToFixed(nota.valorServico)}</ValorServicos>
                            <ValorDeducoes>${safeToFixed(nota.valorDeducao)}</ValorDeducoes>
                            <ValorPis>${safeToFixed(nota.valorPis)}</ValorPis>
                            <ValorCofins>${safeToFixed(nota.valorCofins)}</ValorCofins>
                            <ValorInss>${safeToFixed(nota.valorInss)}</ValorInss>
                            <ValorIr>${safeToFixed(nota.valorIr)}</ValorIr>
                            <ValorCsll>${safeToFixed(nota.valorCsll)}</ValorCsll>
                            <OutrasRetencoes>0.00</OutrasRetencoes>
                            <ValorIss>${safeToFixed(nota.valorIss)}</ValorIss>
                            <Aliquota>${safeToFixed(nota.aliquota)}</Aliquota>
                            <DescontoIncondicionado>0.00</DescontoIncondicionado>
                            <DescontoCondicionado>0.00</DescontoCondicionado>
                        </Valores>
                        <IssRetido>${nota.issRetido}</IssRetido>
                        <ItemListaServico>${nota.itemLista}</ItemListaServico>
                        ${nota.codCnae ? `<CodigoCnae>${nota.codCnae}</CodigoCnae>` : ''}
                        <Discriminacao>${escapeXML(descricaoPrincipal)}</Discriminacao>
                        <CodigoMunicipio>${nota.codMunPrestacao}</CodigoMunicipio>
                        <MunicipioIncidencia>${nota.codMunPrestacao}</MunicipioIncidencia>
                    </Servico>
                    <Tomador>
                        <IdentificacaoTomador>
                            ${nota.tomadorDoc && nota.tomadorDoc.length === 11 ? `<CpfCnpj><Cpf>${nota.tomadorDoc}</Cpf></CpfCnpj>` : ''}
                            ${nota.tomadorDoc && nota.tomadorDoc.length === 14 ? `<CpfCnpj><Cnpj>${nota.tomadorDoc}</Cnpj></CpfCnpj>` : ''}
                            ${nota.tomadorIM ? `<InscricaoMunicipal>${nota.tomadorIM}</InscricaoMunicipal>` : ''}
                        </IdentificacaoTomador>
                        <RazaoSocial>${escapeXML(nota.tomadorRazao)}</RazaoSocial>
                        <Endereco>
                            <Endereco>${escapeXML(nota.tomadorEnd)}</Endereco>
                            <Numero>${nota.tomadorNum}</Numero>
                            ${nota.tomadorComp ? `<Complemento>${escapeXML(nota.tomadorComp)}</Complemento>` : ''}
                            <Bairro>${escapeXML(nota.tomadorBairro)}</Bairro>
                            <CodigoMunicipio>${nota.tomadorCodMun}</CodigoMunicipio>
                            <Uf>${nota.tomadorUF}</Uf>
                            <Cep>${nota.tomadorCEP}</Cep>
                        </Endereco>
                        ${nota.tomadorEmail ? `<Contato><Email>${nota.tomadorEmail}</Email></Contato>` : ''}
                    </Tomador>
                    <OptanteSimplesNacional>${nota.optanteSimples}</OptanteSimplesNacional>
                    <IncentivoFiscal>2</IncentivoFiscal>
                </InfDeclaracaoPrestacaoServico>
            </DeclaracaoPrestacaoServico>
        </InfNfse>
    </Nfse>
</CompNfse>`;
            } catch (e) {
                console.error("Erro ao gerar XML da nota:", nota, e);
                return "";
            }
        }
        
        function gerarXML_PedidoCancelamento(nota, config) {
            return `<Pedido>
    <InfPedidoCancelamento>
        <IdentificacaoNfse>
            <Numero>${nota.numero}</Numero>
            <CpfCnpj><Cnpj>${nota.prestadorCnpj || config.cnpjPrestador}</Cnpj></CpfCnpj>
            <InscricaoMunicipal>${nota.prestadorIM || config.inscricaoMunicipalPrestador}</InscricaoMunicipal>
            <CodigoMunicipio>${nota.prestadorCodMun || config.codMunEmpresa}</CodigoMunicipio>
        </IdentificacaoNfse>
        <CodigoCancelamento>0001</CodigoCancelamento>
    </InfPedidoCancelamento>
</Pedido>`;
        }
        
        function gerarRelatorioPDF(colNotas, tituloRelatorio, isCancelada, headerInfo = {}) {
            if (!colNotas || colNotas.length === 0) return null;
            const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });
            const pageHeader = (data, title) => {
                const margin = data.settings.margin.left;
                doc.setFontSize(16); doc.setFont('helvetica', 'bold');
                doc.text(headerInfo.razaoSocial || 'Relatório de Notas Fiscais', margin, 15);
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`CNPJ: ${headerInfo.cnpj || 'N/A'}`, margin, 21);
                doc.text(`Mês Referência: ${headerInfo.mesRef || 'N/A'}`, doc.internal.pageSize.getWidth() - margin, 21, { align: 'right' });
                if (title) {
                    doc.setFontSize(12); doc.setFont('helvetica', 'bold');
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
                }
            };
            if (isCancelada) {
                doc.autoTable({
                    head: [['Nº NFS-e', 'Data Emissão', 'Local da Prestação', 'Data Cancelamento', 'Status']],
                    body: colNotas.map(nota => [nota.numero, (nota.dataEmissao || '').split('T')[0], nota.prestacaoLocal, (nota.dataCancelamento || '').split('T')[0], 'Cancelada']),
                    startY: 35, margin: { top: 35 }, theme: 'striped',
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 8 }, didDrawPage: (data) => pageHeader(data, tituloRelatorio)
                });
            } else {
                const clientes = colNotas.reduce((acc, nota) => {
                    const idCliente = nota.tomadorDoc || nota.tomadorRazao;
                    if (!acc[idCliente]) acc[idCliente] = { razaoSocial: nota.tomadorRazao, cnpj: nota.tomadorDoc, total: 0, servicos: new Set() };
                    acc[idCliente].total += nota.valorServico;
                    acc[idCliente].servicos.add(simplifyServiceDescription(nota.discriminacao));
                    return acc;
                }, {});
                const ranking = Object.values(clientes).sort((a, b) => b.total - a.total);
                doc.autoTable({
                    head: [['#', 'Cliente', 'CNPJ/CPF', 'Valor Total', 'Serviços Contratados (Amostra)']],
                    body: ranking.slice(0, 15).map((c, i) => [i + 1, c.razaoSocial, c.cnpj, formatCurrency(c.total), Array.from(c.servicos).join('; ')]),
                    startY: 35, margin: { top: 35 }, theme: 'striped', headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 8 }, columnStyles: { 4: { cellWidth: 'auto' } }, didDrawPage: (data) => pageHeader(data, "Ranking de Clientes")
                });
                doc.addPage();
                const summary = colNotas.reduce((acc, nota) => {
                    const location = nota.prestacaoLocal || 'Não especificado';
                    if (!acc[location]) acc[location] = { count: 0, valorServico: 0, valorIss: 0, valorLiquido: 0 };
                    acc[location].count++;
                    acc[location].valorServico += nota.valorServico;
                    acc[location].valorIss += nota.valorIss;
                    nota.valorLiquido = nota.valorServico - (nota.valorIr || 0) - (nota.valorPis || 0) - (nota.valorCofins || 0) - (nota.valorCsll || 0) - (nota.valorInss || 0) - (nota.valorIssRetido || 0) - (nota.valorDeducao || 0);
                    acc[location].valorLiquido += nota.valorLiquido;
                    return acc;
                }, {});
                const summaryBody = Object.entries(summary).map(([loc, data]) => [loc, data.count, formatCurrency(data.valorServico), formatCurrency(data.valorIss), formatCurrency(data.valorLiquido)]);
                if (summaryBody.length > 0) {
                    doc.autoTable({
                        head: [['Local da Prestação', 'Qtd. Notas', 'Vlr. Serviços', 'Vlr. ISS', 'Vlr. Líquido']],
                        body: summaryBody, startY: 35, margin: { top: 35 }, theme: 'striped', headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                        styles: { fontSize: 9 }, didDrawPage: (data) => pageHeader(data, "Sintético por Local de Prestação")
                    });
                }
                doc.addPage();
                const head = [['Nº', 'Data', 'Local Prest.', 'Vlr. Serviço', 'Base ISS', 'Alíq.', 'Vlr. ISS', 'Vlr. IR', 'Vlr. PIS', 'Vlr. COFINS', 'Vlr. CSLL', 'Vlr. INSS', 'Outros', 'Base Ret.', 'Vlr. ISS Ret.', 'Vlr. Líquido', 'Status', 'Cód. Serv.']];
                let totais = { valServ: 0, baseNorm: 0, issNorm: 0, ir: 0, pis: 0, cofins: 0, csll: 0, inss: 0, outros: 0, baseRet: 0, issRet: 0, liq: 0 };
                const body = colNotas.map(nota => {
                    nota.valorLiquido = nota.valorServico - (nota.valorIr || 0) - (nota.valorPis || 0) - (nota.valorCofins || 0) - (nota.valorCsll || 0) - (nota.valorInss || 0) - (nota.valorIssRetido || 0) - (nota.valorDeducao || 0);
                    const baseCalculoNormal = nota.issRetido === "1" ? 0 : nota.valorServico;
                    const vlrIssNormal = nota.issRetido === "1" ? 0 : nota.valorIss;
                    const baseCalculoRetido = nota.issRetido === "1" ? nota.valorServico : 0;
                    totais.valServ += nota.valorServico; totais.baseNorm += baseCalculoNormal; totais.issNorm += vlrIssNormal; totais.ir += nota.valorIr;
                    totais.pis += nota.valorPis; totais.cofins += nota.valorCofins; totais.csll += nota.valorCsll; totais.inss += nota.valorInss;
                    totais.outros += nota.valorDeducao; totais.baseRet += baseCalculoRetido; totais.issRet += nota.valorIssRetido; totais.liq += nota.valorLiquido;
                    return [nota.numero, (nota.dataEmissao || '').split('T')[0], nota.prestacaoLocal, formatCurrency(nota.valorServico), formatCurrency(baseCalculoNormal), `${(nota.aliquota || 0).toFixed(2)}%`, formatCurrency(vlrIssNormal), formatCurrency(nota.valorIr), formatCurrency(nota.valorPis), formatCurrency(nota.valorCofins), formatCurrency(nota.valorCsll), formatCurrency(nota.valorInss), formatCurrency(nota.valorDeducao), formatCurrency(baseCalculoRetido), formatCurrency(nota.valorIssRetido), formatCurrency(nota.valorLiquido), 'Autorizada', nota.itemLista];
                });
                const foot = [[{ content: 'TOTAIS', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } }, formatCurrency(totais.valServ), formatCurrency(totais.baseNorm), '', formatCurrency(totais.issNorm), formatCurrency(totais.ir), formatCurrency(totais.pis), formatCurrency(totais.cofins), formatCurrency(totais.csll), formatCurrency(totais.inss), formatCurrency(totais.outros), formatCurrency(totais.baseRet), formatCurrency(totais.issRet), formatCurrency(totais.liq), '', '']];
                doc.autoTable({
                    head, body, foot, startY: 35, theme: 'striped', margin: { top: 35 },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    footStyles: { fillColor: [232, 232, 232], textColor: 0, fontStyle: 'bold' },
                    styles: { fontSize: 6, cellPadding: 1.5 }, didDrawPage: (data) => pageHeader(data, "Detalhamento das Notas Fiscais")
                });
            }
            return doc.output('blob');
        }

        async function processarArquivos() {
            processarBtn.disabled = true;
            processarBtn.textContent = 'Processando...';
            resultadosDiv.classList.remove('hidden');
            logMessagesDiv.innerHTML = '';
            downloadLinksDiv.innerHTML = '';

            const config = {
                cnpjPrestador: cnpjInput.value.replace(/\D/g, ''),
                inscricaoMunicipalPrestador: imEmpresaInput.value.trim(),
                municipioPrestador: municipioEmpresaInput.value,
                ufPrestador: ufEmpresaSelect.value,
                razaoSocialPrestador: razaoSocialEmpresaInput.value,
                codMunEmpresa: findIBGECode(municipioEmpresaInput.value, ufEmpresaSelect.value)
            };

            if (config.codMunEmpresa === '9999999') {
                log(`Município da empresa inválido. Verifique a seleção.`, 'error');
                processarBtn.disabled = false; processarBtn.textContent = 'Processar Arquivos';
                return;
            }

            let notasConsolidadas = [];
            for (const file of arquivosSelecionados) {
                const notasDoArquivo = await processarArquivo(file, config);
                notasConsolidadas.push(...notasDoArquivo.map(n => ({ ...n, originalFilename: file.name })));
            }
            
            if (notasConsolidadas.length === 0) {
                log("Nenhuma nota fiscal válida encontrada para processar.", 'error');
                processarBtn.disabled = false; processarBtn.textContent = 'Processar Arquivos';
                return;
            }

            const colPrestados = [], colTomados = [], colCancelados = [];
            notasConsolidadas.forEach(nota => {
                if (nota.prestadorCnpj === config.cnpjPrestador) {
                    if (nota.situacao === "CANCELADA" || nota.situacao === "SUBSTITUIDA") {
                        colCancelados.push(nota);
                    } else {
                        colPrestados.push(nota);
                    }
                } else if (nota.tomadorDoc === config.cnpjPrestador) {
                    colTomados.push(nota);
                }
            });

            log(`Resumo: ${colPrestados.length} prestados, ${colTomados.length} tomados, ${colCancelados.length} cancelados.`, 'success');
            
            const filesToZip = [];
            const xmlHeader = '<?xml version="1.0" encoding="UTF-8"?>';

            if (modoGeracaoEscolhido === 'LOTE') {
                if (colPrestados.length > 0) {
                    const lote = colPrestados.map(n => gerarXML_CompNfse(n, config)).join('\n');
                    filesToZip.push({ name: 'ServicosPrestados_Lote.xml', content: `${xmlHeader}<LoteNfse xmlns="http://www.abrasf.org.br/nfse.xsd">${lote}</LoteNfse>` });
                }
                if (colTomados.length > 0) {
                    const lote = colTomados.map(n => gerarXML_CompNfse(n, config)).join('\n');
                    filesToZip.push({ name: 'ServicosTomados_Lote.xml', content: `${xmlHeader}<LoteNfse xmlns="http://www.abrasf.org.br/nfse.xsd">${lote}</LoteNfse>` });
                }
                if (colCancelados.length > 0) {
                    const lote = colCancelados.map(n => gerarXML_PedidoCancelamento(n, config)).join('\n');
                    filesToZip.push({ name: 'Cancelamentos_Lote.xml', content: `${xmlHeader}<CancelarNfseEnvio xmlns="http://www.abrasf.org.br/nfse.xsd">${lote}</CancelarNfseEnvio>` });
                }
            } else { // INDIVIDUAL
                colPrestados.forEach(n => filesToZip.push({ name: `Prestada_${n.numero}.xml`, content: gerarXML_CompNfse(n, config) }));
                colTomados.forEach(n => filesToZip.push({ name: `Tomada_${n.numero}.xml`, content: gerarXML_CompNfse(n, config) }));
                colCancelados.forEach(n => filesToZip.push({ name: `Cancelamento_${n.numero}.xml`, content: `${xmlHeader}<CancelarNfseEnvio xmlns="http://www.abrasf.org.br/nfse.xsd">${gerarXML_PedidoCancelamento(n, config)}</CancelarNfseEnvio>` }));
            }
            
            // Gerar e adicionar PDFs ao ZIP
            const headerInfo = { razaoSocial: config.razaoSocialPrestador, cnpj: config.cnpjPrestador, mesRef: extrairMesReferencia(notasConsolidadas) };
            
            const prestadosBlob = gerarRelatorioPDF(colPrestados, "Relatório de Serviços Prestados", false, headerInfo);
            if (prestadosBlob) filesToZip.push({ name: "Relatorio_Servicos_Prestados.pdf", content: prestadosBlob });
            
            const tomadosBlob = gerarRelatorioPDF(colTomados, "Relatório de Serviços Tomados", false, headerInfo);
            if (tomadosBlob) filesToZip.push({ name: "Relatorio_Servicos_Tomados.pdf", content: tomadosBlob });

            const canceladosBlob = gerarRelatorioPDF(colCancelados, "Relatório de Notas Canceladas", true, headerInfo);
            if (canceladosBlob) filesToZip.push({ name: "Relatorio_Notas_Canceladas.pdf", content: canceladosBlob });

            if (filesToZip.length > 0) {
                await downloadZip(`abrasf_convertidos_${Date.now()}.zip`, filesToZip);
            } else {
                log('Nenhum arquivo (XML ou PDF) foi gerado.', 'error');
            }

            processarBtn.disabled = false;
            processarBtn.textContent = 'Processar Arquivos';
        }

        // --- Inicialização e Listeners ---
        function init() {
            competenciaAnoInput.value = new Date().getFullYear();
            [ufEmpresaSelect, municipioEmpresaInput, competenciaMesSelect, competenciaAnoInput, imEmpresaInput, cnpjInput].forEach(el => {
                el.addEventListener('input', updateProcessarBtnState);
                el.addEventListener('change', updateProcessarBtnState);
            });
            cnpjInput.addEventListener('blur', handleCnpjBlur);
            ufEmpresaSelect.addEventListener('change', (e) => atualizarMunicipios(e.target.value));
            modoGeracaoButtons.forEach(button => button.addEventListener('click', () => {
                modoGeracaoEscolhido = button.dataset.mode;
                modoGeracaoButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                updateProcessarBtnState();
            }));
            [tabXmlBtn, tabTxtBtn, tabPdfBtn].forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            setupDragDrop(dragDropAreaXml, xmlFilesInput);
            setupDragDrop(dragDropAreaTxt, txtFilesInput);
            setupDragDrop(dragDropAreaPdf, pdfFilesInput);
            processarBtn.addEventListener('click', processarArquivos);
            switchTab('xml');
            updateProcessarBtnState();
        }
        init();
    });
    </script>
</body>
</html>
